<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Web Speech API Test </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <style>
        /*
           列印時 <body>, <pre> 之 css 需相同
           -webkit-print-color-adjust: exact --> 讓chrome可列印背景圖
        */
        
        body {
            background-color: lightblue;
            -webkit-print-color-adjust: exact;
        }
        
        #print_parts {
            background-color: yellow;
            -webkit-print-color-adjust: exact;
        }
        
        #spBestResult {
            background-color: yellow;
            -webkit-print-color-adjust: exact;
        }
    </style>
</head>

<body>
    <input type="button" id="btnState" value="開始辨識" onclick="btnStateClick()">
    <input type="button" id="btnClearLastItem" value="清除最後一項" onclick="clearLastItem()" disabled="disable">
    <input type="button" id="btnClearAll" value="全部清除" onclick="clearAll()" disabled="disable">
    <input type="button" id="btnPrint" value="列印" onclick="print()" disabled="disable">
    <h4>狀態：<span id="spState"></span></h4>
    <h4>最佳即時辯識結果：</h4>
    <span id="spBestResult"></span>
    <h4>辨識的全部結果會顯示在下方選單：</h4>
    <div id="print_parts">
        <span id="spResult"></span>
    </div>
    <script type="text/javascript">
        var len = 0; //語音辨識陣列長度
        var temp = 0; //暫存語音辨識陣列長度
        var final = 0; //儲存總辨識長度
        var res = ""; //儲存最佳辨識結果
        var resTemp = ""; //暫存最佳辨識結果
        var _isFirstResult = true;
        var recognizing;
        var recognition = new webkitSpeechRecognition(); //套用chrome語音辨識API
        recognition.continuous = true; //即時辨識
        recognition.interimResults = true; //是否顯示中間辨識結果
        recognition.lang = "cmn-Hant-TW"; //語言:中文(台灣)
        recognition.onstart = function () {
            console.log("開始辨識...");
            $("#btnPrint").prop("disabled", true);
            $("#spState").text("辨識中!");
            final = $("select").length;
            console.log("len: " + len);
            console.log("temp: " + temp);
            console.log("final: " + final);
        }
        recognition.onend = function () {
            console.log("停止辨識!");
            $("#spState").text("停止辨識!");
            recognizing = false;
            _isFirstResult = true;
            $("#btnState").prop("value", "開始辨識");
            final = $("select").length;
            temp = 0;
            if ($("select").length != 0) {
                $("#spResult").append("<span class='spEnd'>" + " 。" + "</span>");
                $("#btnPrint").prop("disabled", false);
            }

            if (resTemp != "") {
                $("#spBestResult .spComma:last-child").remove();
                $("#spBestResult").append("<span class='spEnd'>" + " 。" + "</span>");
            }

            console.log("len: " + len);
            console.log("temp: " + temp);
            console.log("final: " + final);
        };
        recognition.maxAlternatives = 10; //最大辨識結果長度
        recognition.onresult = function (event) {
            len = event.resultIndex;
            console.log("onresult");
            console.log(event.results);
            if ($("select").length != 0) {
                $("#btnClearLastItem").prop("disabled", false);
                $("#btnClearAll").prop("disabled", false);
            }
            if (len == temp) {
                if (_isFirstResult) {
                    _isFirstResult = false;
                    if (len == 0) {
                        if ($("select").length == 0) {
                            $("#spResult").append("<select class='select'>" + "</select>");
                        } else {
                            $("#spResult").append("<span class='spComma'>" + " ， " + "</span>");
                            $("#spResult").append("<select class='select'>" + "</select>");
                            $(".spEnd").remove();
                        }
                    } else {
                        $("#spResult").append("<span class='spComma'>" + " ， " + "</span>");
                        $("#spResult").append("<select class='select'>" + "</select>");
                    }
                }

                if (event.results[len].isFinal) {
                    $(".select:eq(" + (len + final) + ")").empty();
                    for (var i = 0; i < event.results[len].length; i++) {
                        var text = event.results[len][i].transcript;
                        $(".select:eq(" + (len + final) + ")").append($("<option></option>").prop("value", text).text(text));
                    }

                    res += "<span class='spComma'>" + " ， " + "</span>";
                    resTemp += res;
                    $("#spBestResult").html(resTemp);
                } else {
                    var text = event.results[len][0].transcript;
                    $(".select:eq(" + (len + final) + ")").html($("<option></option>").prop("value", text).text(text));

                    if ($("#spBestResult :has('.spEnd')")) {
                        $(".spEnd").remove();
                        resTemp = $("#spBestResult").html() + "<span class='spComma'>" + " ， " + "</span>";
                    }
                    res = "<span class='bestRes'>" + text + "</span>";
                    $("#spBestResult").html(resTemp + res);
                }
            } else {
                _isFirstResult = true;
                temp++;
            }

            console.log("len: " + len);
            console.log("temp: " + temp);
            console.log("final: " + final);
        }

        function start() {
            recognition.start();
            recognizing = true;
        }

        function btnStateClick() {
            if ($("#btnState").val() == "開始辨識") {
                start();
                $("#btnState").prop("value", "停止辨識");
            } else {
                recognition.stop();
            }
        }

        function clearLastItem() {
            var num = $(".select").length;
            $(".spEnd").remove();
            if (num > 1) {
                $(".bestRes:last-child").remove();
                $(".select:last-child").remove();
                $("#spResult .spComma:last-child").remove();
                $("#spBestResult .spComma:last-child").remove();
            } else if (num == 1) {
                $(".bestRes:last-child").remove();
                $(".select:last-child").remove();
                $("#btnPrint").prop("disabled", true);
                $("#btnClearLastItem").prop("disabled", true);
                $("#btnClearAll").prop("disabled", true);
            } else {
                $("#btnPrint").prop("disabled", true);
                $("#btnClearLastItem").prop("disabled", true);
                $("#btnClearAll").prop("disabled", true);
            }
            if (!recognizing) {
                $("#spResult").append("<span class='spEnd'>" + " 。" + "</span>");
                $("#spBestResult").append("<span class='spEnd'>" + " 。" + "</span>");
            }
            final = $("select").length;
            resTemp = $("#spBestResult").html();
        }

        function clearAll() {
            temp = 0;
            final = 0;
            res = "";
            resTemp = "";
            $(".select").remove();
            $(".bestRes").remove();
            $(".spComma").remove();
            $(".spEnd").remove();
            $("#btnClearLastItem").prop("disabled", true);
            $("#btnClearAll").prop("disabled", true);
            $("#btnPrint").prop("disabled", true);
        }

        function getText() {
            var text = "";
            for (var i = 0; i < $("select").length; i++) {
                if (i == $("select").length - 1) {
                    text += $(".select:eq(" + i + ") :selected").text();
                    text += "。";
                } else {
                    text += $(".select:eq(" + i + ") :selected").text();
                    text += "，";
                }
            }
            console.log(text);
            return text;
        }

        function print() {
            var printPage = window.open("", "Printing...", "");
            printPage.document.open();
            printPage.document.write("<html><head>" + "<style>body{background-color: lightblue;-webkit-print-color-adjust: exact;}" + "pre {background-color: yellow;-webkit-print-color-adjust: exact;}" + "</style>" + "</head><body onload='window.print();window.close()'>");
            printPage.document.write("<pre>");
            printPage.document.write(getText());
            printPage.document.write("</pre>");
            printPage.document.close("</body></html>");
        }
    </script>
</body>

</html>
