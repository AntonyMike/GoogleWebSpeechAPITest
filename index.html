<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Web Speech API Test </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <style>
        /*列印時 <body>, <pre> 之 css 需相同*/
        body {
            background-color: lightblue;
            -webkit-print-color-adjust: exact;
        }
        
        #print_parts {
            background-color: yellow;
            -webkit-print-color-adjust: exact;
        }        
    </style>
</head>

<body>
    <button id="btnState" onclick="btnStateClick();">開始辨識</button>
    <button id="btnClearLast" onclick="clearLast()" disabled="disable">清除最後一項</button>
    <button id="btnClearAll" onclick="clearAll()" disabled="disable">全部清除</button>
    <button id="btnPrint" onclick="print()" disabled="disable">列印</button>
    <h4>辨識的結果會顯示在下方選單：</h4>
    <div id="print_parts">
        <span id="spResult"></span>
    </div>
    <script type="text/javascript">
        var len = 0; //語音辨識陣列長度
        var temp = 0; //暫存語音辨識陣列長度
        var final = 0; //儲存前一次語音辨識陣列的長度
        var _isFirstResult = true;
        var recognizing;
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true; //及時辨識
        recognition.interimResults = true; //是否顯示中間辨識結果
        recognition.lang = "cmn-Hant-TW"; //語言:中文(台灣)
        recognition.onstart = function () {
            console.log('開始辨識...');
            document.getElementById('btnPrint').disabled = true;
        }
        recognition.onend = function () {
            console.log('停止辨識!');
            final += temp;
            temp = 0;
            document.getElementById("spResult").innerHTML += "<span class='spEnd'>" + " 。" + "</span>";
            document.getElementById('btnPrint').disabled = false;
        };
        recognition.maxAlternatives = 10; //最大辨識結果長度
        recognition.onresult = function (event) {
            len = event.resultIndex;
            console.log(len);
            console.log(event.results);
            if ($('select').length != 0) {
                document.getElementById('btnClearLast').disabled = false;
                document.getElementById('btnClearAll').disabled = false;
            }
            if (len == temp) {
                if (_isFirstResult) {
                    _isFirstResult = false;
                    if (len == 0) {
                        if (final != 0) {
                            document.getElementById("spResult").innerHTML += "<span class='spComma'>" + " ， " + "</span>";
                            document.getElementById("spResult").innerHTML += "<select id='select" + (len + final + 2) + "' class='select'>" + "</select>";
                            $(".spEnd").remove();
                        } else {
                            document.getElementById("spResult").innerHTML += "<select id='select" + (len + 1) + "' class='select'>" + "</select>";
                        }
                    } else {
                        if (final != 0) {
                            document.getElementById("spResult").innerHTML += "<span class='spComma'>" + " ， " + "</span>";
                            document.getElementById("spResult").innerHTML += "<select id='select" + (len + final + 2) + "' class='select'>" + "</select>";
                        } else {
                            document.getElementById("spResult").innerHTML += "<span class='spComma'>" + " ， " + "</span>";
                            document.getElementById("spResult").innerHTML += "<select id='select" + (len + 1) + "' class='select'>" + "</select>";
                        }
                    }
                }
                if (event.results[len].isFinal) {
                    for (var i = 0; i < event.results[len].length; i++) {
                        var text = event.results[len][i].transcript;
                        if (final != 0) {
                            document.getElementById('select' + (len + final + 2)).options[i] = new Option(text, text);
                        } else {
                            document.getElementById('select' + (len + 1)).options[i] = new Option(text, text);
                        }
                    }
                }
            } else {
                _isFirstResult = true;
                temp++;
            }
        }

        function reset() {
            recognition.stop();
            recognizing = false;
            _isFirstResult = true;
            document.getElementById('btnState').innerHTML = "開始辨識";
        }

        function start() {
            recognition.start();
            recognizing = true;
        }

        function btnStateClick() {
            var elem = document.getElementById('btnState');
            var txt = elem.textContent || elem.innerText;
            if (txt == "開始辨識") {
                start();
                elem.innerHTML = "停止辨識";
            } else {
                reset();
                elem.innerHTML = "開始辨識";
            }
        }

        function clearLast() {
            var num = $(".select").length;
            if (num > 1) {
                $("span .select:last-child").remove();
                $("span .spComma:last-child").remove();
            } else if (num == 1) {
                $("span .select:last-child").remove();
                $("span .spComma:last-child").remove();
                $(".spEnd").remove();
                document.getElementById('btnClearLast').disabled = true;
                document.getElementById('btnClearAll').disabled = true;
            } else {
                document.getElementById('btnClearLast').disabled = true;
                document.getElementById('btnClearAll').disabled = true;
            }
        }

        function clearAll() {
            temp = 0;
            final = 0;
            $(".select").remove();
            $(".spComma").remove();
            $(".spEnd").remove();
            document.getElementById('btnClearLast').disabled = true;
            document.getElementById('btnClearAll').disabled = true;
        }

        function print() {
            var value = document.getElementById("print_parts").innerHTML;
            var printPage = window.open("", "Printing...", "");
            printPage.document.open();
            printPage.document.write("<html><head>" + "<style>body{background-color: lightblue;-webkit-print-color-adjust: exact;}" 
                                     + "pre {background-color: yellow;-webkit-print-color-adjust: exact;}" + "</style>" 
                                     + "</head><body onload='window.print();window.close()'>");
            printPage.document.write("<pre>");
            printPage.document.write(value);
            printPage.document.write("</pre>");
            printPage.document.close("</body></html>");
        }
    </script>
</body>

</html>
