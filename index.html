<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Web Speech API Test </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>

<body>
    <button id="btnState" onclick="btnStateClick();">開始辨識</button>
    <button id="btnClearLast" onclick="clearLast()" disabled="disable">清除最後一項</button>
    <button id="btnClearAll" onclick="clearAll()" disabled="disable">全部清除</button>
    <h4>辨識的文字會顯示在下方選單：</h4> <span id="spResult"></span>
    <script type="text/javascript">
        var len = 0;
        var temp = 0;
        var _isFirstResult = true;
        var recognizing;
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "cmn-Hant-TW";
        recognition.onstart = function () {
            console.log('開始辨識...');
        }
        recognition.onend = function () {
            console.log('停止辨識!');
            reset();
        };
        recognition.maxAlternatives = 10;
        recognition.onresult = function (event) {
            len = event.resultIndex;
            console.log(len);
            if ($('select').length != 0) {
                document.getElementById('btnClearLast').disabled = false;
                document.getElementById('btnClearAll').disabled = false;
            }
            if (len == temp) {
                if (_isFirstResult) {
                    _isFirstResult = false;
                    if (len == 0) {
                        document.getElementById("spResult").innerHTML += "<select id='select" + len + "' class='select'>" + "</select>";
                    } else {
                        document.getElementById("spResult").innerHTML += "<span class='spPlus'>" + " + " + "</span>";
                        document.getElementById("spResult").innerHTML += " + " + "<select id='select" + len + "' class='select'>" + "</select>";
                    }
                }
                var j = event.results[len].length - 1;
                var text = event.results[len][j].transcript;
                document.getElementById('select' + len).options[j] = new Option(text, text);
            } else {
                _isFirstResult = true;
                temp++;
            }
            temp = len;
            len = 0;
        }

        function reset() {
            recognition.stop();
            recognizing = false;
            document.getElementById('btnState').innerHTML = "開始辨識";
        }

        function start() {
            recognition.start();
            recognizing = true;
        }

        function btnStateClick() {
            var elem = document.getElementById('btnState');
            var txt = elem.textContent || elem.innerText;
            if (txt == "開始辨識") {
                start();
                elem.innerHTML = "停止辨識";
            } else {
                reset();
                elem.innerHTML = "開始辨識";
            }
        }

        function clearLast() {
            var num = $(".select").length;
            if (num > 1) {
                $("span .spPlus:last-child").remove();
                $("span .select:last-child").remove();
            } else if (num == 1) {
                $("span .spPlus:last-child").remove();
                $("span .select:last-child").remove();
                document.getElementById('btnClearLast').disabled = true;
                document.getElementById('btnClearAll').disabled = true;
            } else {
                document.getElementById('btnClearLast').disabled = true;
                document.getElementById('btnClearAll').disabled = true;
            }
        }

        function clearAll() {
            $(".select").remove();
            $(".spPlus").remove();
            document.getElementById('btnClearLast').disabled = true;
            document.getElementById('btnClearAll').disabled = true;
        }
    </script>
</body>

</html>
