<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Google Web Speech API Test </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <style>
        /*列印時 <body>, <pre> 之 css 需相同*/
        
        body {
            background-color: lightblue;
            -webkit-print-color-adjust: exact;
        }
        
        #print_parts {
            background-color: yellow;
            -webkit-print-color-adjust: exact;
        }
    </style>
</head>

<body>
    <input type="button" id="btnState" value="開始辨識" onclick="btnStateClick();">
    <input type="button" id="btnClearLast" value="清除最後一項" onclick="clearLast()" disabled="disable">
    <input type="button" id="btnClearAll" value="全部清除" onclick="clearAll()" disabled="disable">
    <input type="button" id="btnPrint" value="列印" onclick="print()" disabled="disable">
    <h4>辨識的結果會顯示在下方選單：</h4>
    <div id="print_parts">
        <span id="spResult"></span>
    </div>
    <script type="text/javascript">
        var len = 0; //語音辨識陣列長度
        var temp = 0; //暫存語音辨識陣列長度
        var final = 0; //儲存前一次語音辨識陣列的長度
        var _isFirstResult = true;
        var recognizing;
        var recognition = new webkitSpeechRecognition();
        recognition.continuous = true; //及時辨識
        recognition.interimResults = true; //是否顯示中間辨識結果
        recognition.lang = "cmn-Hant-TW"; //語言:中文(台灣)
        recognition.onstart = function() {
            console.log("開始辨識...");
            $("#btnPrint").prop("disabled", true);
        }
        recognition.onend = function() {
            console.log("停止辨識!");
            if (temp == 0 && $("select").length == 1) {
                final = 1;
            } else {
                final += temp;
            }
            temp = 0;
            if ($("select").length != 0) {
                $("#spResult").append("<span class='spEnd'>" + " 。" + "</span>");
                $("#btnPrint").prop("disabled", false);
            }
        };
        recognition.maxAlternatives = 10; //最大辨識結果長度
        recognition.onresult = function(event) {
            len = event.resultIndex;
            console.log(len);
            console.log(event.results);
            if ($("select").length != 0) {
                $("#btnClearLast").prop("disabled", false);
                $("#btnClearAll").prop("disabled", false);
            }
            if (len == temp) {
                if (_isFirstResult) {
                    _isFirstResult = false;
                    if (len == 0) {
                        if (final != 0) {
                            $("#spResult").append("<span class='spComma'>" + " ， " + "</span>");
                            $("#spResult").append("<select id='select" + (len + final + 2) + "' class='select'>" + "</select>");
                            $(".spEnd").remove();
                        } else {
                            $("#spResult").append("<select id='select" + (len + 1) + "' class='select'>" + "</select>");
                        }
                    } else {
                        if (final != 0) {
                            $("#spResult").append("<span class='spComma'>" + " ， " + "</span>");
                            $("#spResult").append("<select id='select" + (len + final + 2) + "' class='select'>" + "</select>");
                        } else {
                            $("#spResult").append("<span class='spComma'>" + " ， " + "</span>");
                            $("#spResult").append("<select id='select" + (len + 1) + "' class='select'>" + "</select>");
                        }
                    }
                }
                if (event.results[len].isFinal) {
                    for (var i = 0; i < event.results[len].length; i++) {
                        var text = event.results[len][i].transcript;
                        if (final != 0) {
                            $("#select" + (len + final + 2)).append($("<option></option>").prop("value", text).text(text));
                        } else {
                            $("#select" + (len + 1)).append($("<option></option>").prop("value", text).text(text));
                        }
                    }
                }
            } else {
                _isFirstResult = true;
                temp++;
            }
        }

        function reset() {
            recognition.stop();
            recognizing = false;
            _isFirstResult = true;
            $("#btnState").prop("value", "開始辨識");
        }

        function start() {
            recognition.start();
            recognizing = true;
        }

        function btnStateClick() {
            if ($("btnState").text() == "開始辨識") {
                start();
                $("btnState").prop("value", "停止辨識");
            } else {
                reset();
                $("btnState").prop("value", "開始辨識");
            }
        }

        function clearLast() {
            var num = $(".select").length;
            $(".spEnd").remove();
            if (num > 1) {
                $("span .select:last-child").remove();
                $("span .spComma:last-child").remove();
                $("#spResult").append("<span class='spEnd'>" + " 。" + "</span>");
            } else if (num == 1) {
                $("span .select:last-child").remove();
                $("#btnClearLast").prop("disabled", true);
                $("#btnClearAll").prop("disabled", true);
            } else {
                $("#btnClearLast").prop("disabled", true);
                $("#btnClearAll").prop("disabled", true)
            }
        }

        function clearAll() {
            temp = 0;
            final = 0;
            $(".select").remove();
            $(".spComma").remove();
            $(".spEnd").remove();
            $("#btnClearLast").prop("disabled", true);
            $("#btnClearAll").prop("disabled", true)
        }

        function getText() {
            var text = "";
            for (var i = 0; i < $("select").length; i++) {
                if (i == $("select").length - 1) {
                    text += $("#select" + (i + 1) + " :selected").text();
                    text += "。";
                } else {
                    text += $("#select" + (i + 1) + " :selected").text();
                    text += "，";
                }
            }
            console.log(text);
            return text;
        }

        function print() {
            var printPage = window.open("", "Printing...", "");
            printPage.document.open();
            printPage.document.write("<html><head>" + "<style>body{background-color: lightblue;-webkit-print-color-adjust: exact;}" + "pre {background-color: yellow;-webkit-print-color-adjust: exact;}" + "</style>" + "</head><body onload='window.print();window.close()'>");
            printPage.document.write("<pre>");
            printPage.document.write(getText());
            printPage.document.write("</pre>");
            printPage.document.close("</body></html>");
        }
    </script>
</body>

</html>
